<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Tracker</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAliEuLSdTEB9G2rzVPN7F7UtlW456-K_k&callback=initMap" async defer></script>
    <script>
        let map;
        let marker;

        // Initialize the map
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 0, lng: 0 }, // Default initial center
                zoom: 12
            });

            marker = new google.maps.Marker({
                position: { lat: 0, lng: 0 },
                map: map,
                title: "Current Location"
            });

            // Open EventSource to receive location updates
            const eventSource = new EventSource("/location-data");
            
            eventSource.onmessage = function(event) {
                try {
                    const location = JSON.parse(event.data);
                    const lat = location.lat;
                    const lng = location.lng;

                    if (lat && lng && lat !== 0 && lng !== 0) {
                        const newLatLng = new google.maps.LatLng(lat, lng);
                        marker.setPosition(newLatLng);
                        map.setCenter(newLatLng);
                        console.log(`Updated location: lat=${lat}, lng=${lng}`);
                    } else {
                        console.warn("Received invalid location data:", location);
                    }
                } catch (error) {
                    console.error("Error updating map:", error);
                }
            };

            eventSource.onerror = function(event) {
                console.error("EventSource error:", event);
            };
        }
    </script>
</head>
<body onload="initMap()">
    <h1>Real-Time Location Tracker</h1>
    <div id="map" style="height: 500px; width: 100%;"></div>
</body>
</html>