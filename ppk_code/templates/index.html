<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAVProxy Logs and Files Viewer</title>
    <style>
        #logs, #files {
            white-space: pre-wrap;
            font-family: monospace;
            margin-top: 20px;
        }
        #loading {
            font-size: 24px;
            color: green;
        }
        .file-link {
            color: blue;
            text-decoration: underline;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>MAVProxy Logs Viewer</h1>
    
    <!-- Buttons to trigger actions -->
    <button id="fetchLogsButton">Fetch Logs</button>
    <button id="fetchFilesButton">List Files</button>

    <!-- Loading spinner -->
    <div id="loading" style="display: none;">File Access is Active.. Please Wait </div>

    <!-- Logs container -->
    <div id="logs" style="display:none;"></div>

    <!-- Files container -->
    <div id="files" style="display:none;"></div>

    <div id="error-message" style="display:none; color: red; font-weight: bold;"></div>


    <script>
        // Fetch logs button handler
        document.getElementById("fetchLogsButton").addEventListener("click", function() {
            document.getElementById("loading").style.display = "block";
            document.getElementById("logs").style.display = "block"; // Show logs container
            document.getElementById("files").style.display = "none"; // Hide files container
            document.getElementById("logs").textContent = "";  // Clear previous logs

            fetch('/fetch_logs')
                .then(response => response.json())
                .then(data => {
                    if (data.status === "loading") {
                        checkLogs();
                    }
                });
        });


        
        // Function to check if logs are available
        function checkLogs() {
    fetch('/logs')
        .then(response => response.json())
        .then(data => {
            if (Object.keys(data.logs).length > 0) {
                // Display logs with download links
                const logsContainer = document.getElementById("logs");
                logsContainer.innerHTML = ""; // Clear previous logs
                Object.keys(data.logs).forEach(log_id => {
                    const logEntry = document.createElement('div');
                    logEntry.innerHTML = `<strong>Log ${log_id}:</strong> ${data.logs[log_id]}`;
                    
                    // Create download button for each log
                    const downloadButton = document.createElement('button');
                    downloadButton.textContent = "Download Log";
                    downloadButton.onclick = function() {
                        downloadLog(log_id);  // Trigger download for this log
                    };

                    logEntry.appendChild(downloadButton);
                    logsContainer.appendChild(logEntry);
                });
                document.getElementById("loading").style.display = "none"; // Hide the loading spinner
                document.getElementById("error-message").style.display = "none"; // Ensure error message is hidden
            } else {
                // Keep checking every 1 second
                setTimeout(checkLogs, 1000);
            }
        })
        .catch(err => {
            console.error("Error fetching logs:", err);
            document.getElementById("loading").style.display = "none"; // Stop loading spinner
            // Optionally display an error message only if needed (e.g., network issues)
            // You can also choose to ignore error handling here
        });
}


        // Function to download log by ID
        function downloadLog(log_id) {
            // Redirect to the download URL for logs
            window.location.href = `/download_log/${log_id}`;
        }

        // Fetch files button handler
        document.getElementById("fetchFilesButton").addEventListener("click", function () {
    document.getElementById("loading").style.display = "block";
    document.getElementById("files").style.display = "block"; // Show files container
    document.getElementById("logs").style.display = "none"; // Hide logs container
    document.getElementById("files").textContent = ""; // Clear previous files
    document.getElementById("error-message").style.display = "none"; // Hide error message

    fetch('/list_files')
        .then(response => response.json())
        .then(data => {
            document.getElementById("loading").style.display = "none"; // Stop loading spinner

            if (data.error === "Logging is active. Cannot list files.") {
                // Display the specific error message in red
                const errorMessage = document.getElementById("error-message");
                errorMessage.textContent = data.error;
                errorMessage.style.display = "block"; // Show error message
            } else if (data.files) {
                const filesContainer = document.getElementById("files");
                data.files.forEach(file => {
                    const fileItem = document.createElement('div');
                    const fileLink = document.createElement('span');
                    fileLink.textContent = file;
                    fileLink.className = "file-link";
                    // Add a click event to download the file
                    fileLink.onclick = function () {
                        downloadFile(file); // Trigger download for this file
                    };
                    fileItem.className = "file-item";
                    fileItem.appendChild(fileLink);
                    filesContainer.appendChild(fileItem);
                });
            } else if (data.error) {
                const filesContainer = document.getElementById("files");
                filesContainer.textContent = "Error: " + data.error;
            }
        })
        .catch(err => {
            document.getElementById("loading").style.display = "none";
            const filesContainer = document.getElementById("files");
            filesContainer.textContent = "Failed to load files.";
            console.error(err);
        });
});


        // Function to download file by filename
        function downloadFile(filename) {
            // Redirect the browser to the download URL for the file
            window.location.href = `/download/${filename}`;
        }

    </script>
</body>
</html>